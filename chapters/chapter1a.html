<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Node_Zero // The Substrate — Interactive Text Adventure</title>
  <!-- Optional: use your existing styles if present -->
  <link href="../css/tailwind.generated.css" rel="stylesheet">
  <link href="../css/styles.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --neon-cyan: #00f0ff;
      --neon-magenta: #ff00e0;
      --neon-green: #00ffa3;
      --amber: #fbbf24;
      --bg-deep: #0a0b10;
    }
    body { background: radial-gradient(1200px 700px at 50% -10%, rgba(0,240,255,0.1), transparent 60%), #0a0b10; }
    .title-font { font-family: 'Orbitron', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .glow-cyan { text-shadow: 0 0 8px rgba(0,240,255,.6), 0 0 18px rgba(0,240,255,.3); }
    .glow-magenta { text-shadow: 0 0 8px rgba(255,0,224,.6), 0 0 18px rgba(255,0,224,.3); }
    .glow-green { text-shadow: 0 0 8px rgba(0,255,163,.6), 0 0 18px rgba(0,255,163,.3); }
    .scanlines { position: relative; }
    .scanlines::after {
      content: ""; position: absolute; inset: 0; pointer-events: none;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.06), rgba(255,255,255,0.06) 1px,
        transparent 1px, transparent 3px
      );
      mix-blend-mode: overlay; opacity: .25; border-radius: .75rem;
    }
    pre, .console-line { white-space: pre-wrap; word-wrap: break-word; }
    .cursor::after { content: '▌'; display: inline-block; animation: blink 1s step-end infinite; color: var(--neon-cyan); margin-left: 2px; }
    @keyframes blink { 0%,100%{opacity:0} 50%{opacity:1} }
    .btn {
      border: 1px solid rgba(255,255,255,.2); padding: .5rem .8rem; border-radius: .5rem;
      background: rgba(255,255,255,.04); transition: .15s ease; display: inline-flex; align-items: center; gap:.5rem;
    }
    .btn:hover { transform: translateY(-1px); background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.35); }
    .btn-green { border-color: rgba(0,255,163,.35); color: var(--neon-green); }
    .btn-cyan { border-color: rgba(0,240,255,.35); color: var(--neon-cyan); }
    .btn-magenta { border-color: rgba(255,0,224,.35); color: var(--neon-magenta); }
    .choice { border: 1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.03); }
    .choice:hover { background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.35); }
    .pill { border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:.15rem .6rem; font-size:.75rem; opacity:.85; }
    .badge { border:1px solid rgba(255,255,255,.2); border-radius:.4rem; padding:.1rem .4rem; font-size:.7rem; opacity:.9; }
    .alert-pulse-red {
      color: #ff3b3b;
      text-shadow: 0 0 8px #ff3b3b, 0 0 18px #ff3b3b, 0 0 32px #ff3b3b;
      animation: alert-pulse 1.1s infinite alternate cubic-bezier(.4,0,.6,1);
      font-weight: bold;
    }
    @keyframes alert-pulse {
      0% { text-shadow: 0 0 8px #ff3b3b, 0 0 18px #ff3b3b, 0 0 32px #ff3b3b; opacity: 1; }
      100% { text-shadow: 0 0 24px #ff3b3b, 0 0 48px #ff3b3b, 0 0 64px #ff3b3b; opacity: 0.7; }
    }
  </style>
</head>
<body class="min-h-screen text-white font-mono px-4 md:px-8 py-8 md:py-12">

  <header class="mb-6 md:mb-10 text-center">
    <h1 class="title-font text-3xl md:text-5xl font-bold glow-cyan">Node_Zero :: The Substrate</h1>
    <p class="mt-2 text-sm md:text-base text-gray-300">Interactive text adventure. Your choices unlock intel and illuminate the universe.</p>
  </header>

  <!-- Controls / Status -->
  <section class="max-w-6xl mx-auto mb-4 md:mb-6 flex flex-wrap gap-2 items-center justify-between text-xs md:text-sm">
    <div class="flex flex-wrap gap-2 items-center">
      <button id="btn-new" class="btn btn-magenta" title="Start over">⟲ New Game</button>
      <button id="btn-continue" class="btn btn-cyan" title="Load last save">⏵ Continue</button>
      <button id="btn-skip" class="btn btn-green" title="Fast-forward current text">⏩ Fast-Forward</button>
    </div>
    <div class="flex items-center gap-3">
      <label class="flex items-center gap-2"><input id="chk-typing" type="checkbox" checked /> <span>Typing</span></label>
      <label class="flex items-center gap-2"><input id="chk-autoscroll" type="checkbox" checked /> <span>Auto-Scroll</span></label>
      <div class="hidden md:flex items-center gap-2">
        <span class="opacity-70">Speed</span>
        <input id="rng-speed" type="range" min="10" max="60" value="18" title="Adjust typing speed" placeholder="Typing speed" />
      </div>
    </div>
  </section>

  <!-- Main Layout -->
  <main class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
    <!-- Console -->
    <section class="lg:col-span-2 bg-black/40 border border-white/10 rounded-xl p-4 md:p-6 scanlines">
      <div id="console-log" class="space-y-3 text-sm md:text-base leading-relaxed my-12 max-h-[70vh] overflow-auto"></div>
      <div id="choices" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
    </section>

    <!-- Intel / Lore Panel -->
    <aside class="bg-black/30 border border-white/10 rounded-xl p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="title-font text-xl glow-green">Intel Unlocked</h2>
        <span id="intel-count" class="pill" title="Intel items unlocked">0</span>
      </div>
      <div id="intel-list" class="space-y-2 text-sm"></div>
      <hr class="my-4 border-white/10"/>
      <div class="space-y-2 text-xs text-gray-300">
        <div><span class="badge">Tip</span> Hover or tap intel titles to expand.</div>
        <div><span class="badge">Note</span> Game auto-saves progress locally.</div>
      </div>
    </aside>
  </main>

  <footer class="max-w-6xl mx-auto text-center text-[11px] md:text-xs text-gray-400 mt-6">
    Central Inquiry • Node_Zero Universe • This is a training simulation.
  </footer>

  <script>
  // ---------------------------
  // Game Data: Intel (Lore)
  // ---------------------------
  const INTEL = {
    substrate: {
      title: 'The Substrate',
      body: `A decentralized mesh of legacy blockchains, storage nodes, and AI-run services that survived chaotic failures. 
      It's not "the internet" or "a metaverse"—it's the quiet plumbing beneath both. Packets, DAOs, file shards, and forgotten servers stitched into a living ruin.`
    },
    echo: {
      title: 'Echo Cipher',
      body: `A signaling pattern hidden across language channels. It isn't about text meaning—it's about cadence, timing, and hesitation. 
      Tracked by agents that recognize communication shapes rather than grammar.`
    },
    entangle: {
      title: 'Entangled Ledger',
      body: `A quantum-ledger concept spanning time slices. Messages can be observed across timelines using pre-agreed protocols. 
      Constraints exist to preserve causality; you can only collapse states left open by the chain's creation.`
    },
    blue: {
      title: 'The Blue (L1 Shard)',
      body: `An AI-powered layer on Lamina1's L1 network. Users can spin up ephemeral micro-metaverses funded by temporary DAOs; 
      spaces dissolve when gas depletes or the shard disconnects.`
    },
    stellar: {
      title: 'Stellar Identity (Muxed Keys)',
      body: `Identity is asserted using Stellar accounts with muxed (M) addresses. Safer flows rotate keys and sign challenges 
      instead of sharing secrets. Good ops practice: short-lived auth + audit trails.`
    },
    lockb0x: {
      title: 'Lockb0x Storage (IPFS/IPNS + Azure)',
      body: `Bring-Your-Own-Storage abstraction. Media and metadata live in IPFS/IPNS with governance and access mediated via an API gateway. 
      Private swarms for sensitive work; public gateways only for whitelisted CIDs.`
    },
    ucc: {
      title: 'UCC Work Orders (CERs)',
      body: `Under UCC Article 12, certain records can be Controllable Electronic Records (CERs). 
      Engagement Offers and Work Orders form a signed chain of custody—who controls, who can transfer, and under what conditions.`
    }
  };

  // ---------------------------
  // Game Data: Scenes
  // Each scene defines: lines[], choices[] {label, next, intel?:[], note?}
  // ---------------------------
  const SCENES = {
    intro: {
      lines: [
        '> LOCATION: Las Vegas, 2142.',
        '> The Strip flickers like a broken circuit on the horizon in the perpetual dusty dusk that surrounds the sprawling, nearly abandonded, metropolis.',
        '> The Substrate hums beneath it all.',
        '>',
        '[INBOUND PACKET DETECTED]',
        'crypttext://node-zero.xyz',
        '"Incoming data packet-stream from unidentifiable origin."',
        '^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^',
        'CHOICES: (1) Open | (2) Trace | (3) Ignore',
        '********************************************',
      ],
      choices: [
        { label: '1) Open the link', next: 'open', intel: ['substrate'] },
        { label: '2) Trace the signal', next: 'trace', intel: ['substrate','echo'] },
        { label: '3) Ignore it', next: 'ignore' }
      ]
    },

    ignore: {
      lines: [
        '> You look away. The room stays too quiet.',
        '[ALERT] Signal returns, louder. Screen pressure rises like a stormfront.',
        'crypttext://node-zero.xyz — reappeared.',
        '^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^',
        'CHOICES: (1) Open | (2) Trace',
        '********************************************',
      ],
      choices: [
        { label: '1) Open the link', next: 'open', intel: ['substrate'] },
        { label: '2) Trace the signal', next: 'trace', intel: ['substrate','echo'] }
      ]
    },

    open: {
      lines: [
        '> You dive blind. Glass becomes water; UI becomes tide.',
        '[SYSTEM WARNING] Unverified origin. Backpressure mounting…',
        'A whisper threads the audio driver: "Enter, or be erased."',
        '^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^',
        'CHOICES: (1) Bail out | (2) Trace anyway',
        '********************************************',
      ],
      choices: [
        { label: '1) Bail out (return to caution)', next: 'trace' },
        { label: '2) Trace anyway (reckless)', next: 'trace', intel: ['echo'] }
      ]
    },

    trace: {
      lines: [
        '> ROUTING TRACE…',        
        'sig://retroactive65',
        'origin://substrate/blue',
        'entropy://96fa88d3',
        'Signature verified: @Retroactive65. Known entity on Lamina1.',
        '^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^',
        'CHOICES: (1) Follow | (2) Copy & sandbox | (3) Send a probe',
        '**************************************************************',
      ],
      choices: [
        { label: '1) Follow the signature', next: 'follow', intel: ['blue'] },
        { label: '2) Copy & sandbox', next: 'sandbox', intel: ['entangle'] },
        { label: '3) Send a probe back', next: 'probe' }
      ]
    },

    follow: {
      lines: [
        '> You chase the trail raw. Exposure risk climbs.',
        '[HINT] Safer practice: containerize unknowns first.',
        'CHOICES: (1) Backtrack to sandbox | (2) Keep following (risky)'
      ],
      choices: [
        { label: '1) Backtrack: Copy & sandbox', next: 'sandbox', intel: ['entangle'] },
        { label: '2) Keep following (risky)', next: 'hit', intel: ['blue'] }
      ]
    },

    hit: {
      lines: [
        '[IMPACT] You take a glancing hit. Logs smear with artifacting.',
        'Decoy is recommended.',
        'CHOICES: (1) Spin a decoy shard | (2) Abort and sandbox properly'
      ],
      choices: [
        { label: '1) Spin a decoy shard', next: 'redirect', intel: ['blue'] },
        { label: '2) Abort and sandbox', next: 'sandbox', intel: ['entangle'] }
      ]
    },

    probe: {
      lines: [
        '> You send a blank packet into the dark.',
        ':: PING ::',
        '.',
        '..',
        '...',
        '[ALERT] Uninterpreted signal may carry state back.',
        'CHOICES: (1) Copy & sandbox | (2) Bail to menu'
      ],
      choices: [
        { label: '1) Copy & sandbox', next: 'sandbox', intel: ['entangle'] },
        { label: '2) Bail (back)', next: 'trace' }
      ]
    },

    sandbox: {
      lines: [
        '> PACKET ISOLATED IN AIR-GAP.',
        '[ALERT] Quantum residue detected.',
        ':: PONG ::',
        '!! System Alert !!',
        'You are observed.',
        'Next contact predicted at 03:33 local, it is now 03:32.',
        'Preparing Options ...',
        'CHOICES: (1) Fortify | (2) Decode residue | (3) Attack first'
      ],
      choices: [
        { label: '1) Fortify defenses', next: 'fortify', intel: ['stellar','lockb0x'] },
        { label: '2) Decode residue', next: 'decode', intel: ['entangle'] },
        { label: '3) Attack first', next: 'attack' }
      ]
    },

    decode: {
      lines: [
        '> You examine the residue with non-interactive tools.',
        'Finding: state hints match an entangled ledger protocol.',
        'Constraint: you can only collapse pre-opened states.',
        'CHOICES: (1) Fortify anyway | (2) Wait for 03:33 quietly'
      ],
      choices: [
        { label: '1) Fortify anyway', next: 'fortify', intel: ['stellar protocol 10578'] },
        { label: '2) Wait quietly (stealth)', next: 'quiet', intel: ['entangle'] }
      ]
    },

    quiet: {
      lines: [
        '03:33 arrives. Pressure-message impacts the sandbox shell.',
        'Your system black-holed 13TB of malformed quantum data.',
        'THE BLUE HAS OPENED.',
        'CHOICES: (1) Redirect to decoy | (2) Step through | (3) Seal gate'
      ],
      choices: [
        { label: '1) Redirect to decoy', next: 'redirect' },
        { label: '2) Step through', next: 'enterBlue', intel: ['blue'] },
        { label: '3) Seal the gate', next: 'seal' }
      ]
    },

    fortify: {
      lines: [
        '> DEFENSE STACK ONLINE:',
        '- Layered firewalls',
        '- Stellar muxed-key rotations',
        '- Lockb0x + VNet isolation',
        '- Daemon: packet-eater ONLINE',
        '03:33 — INBOUND MESSAGE',
        'THE BLUE OPENS.',
        'ENTER, OR BE ERASED.',
        'CHOICES: (1) Step through | (2) Redirect to decoy | (3) Seal gate'
      ],
      choices: [
        { label: '1) Step through', next: 'enterBlue', intel: ['blue'] },
        { label: '2) Redirect to decoy', next: 'redirect' },
        { label: '3) Seal gate', next: 'seal' }
      ]
    },

    attack: {
      lines: [
        '> You strike first. The system rumbles with recoil.',
        'Result: minimal intel gained; risk escalated. The gate still forms.',
        'CHOICES: (1) Redirect | (2) Step through | (3) Seal gate'
      ],
      choices: [
        { label: '1) Redirect', next: 'redirect' },
        { label: '2) Step through', next: 'enterBlue', intel: ['blue'] },
        { label: '3) Seal gate', next: 'seal' }
      ]
    },

    seal: {
      lines: [
        '> You seal the gate. Silence falls like ash.',
        'The trail begins to fade. But silence never lasts here.',
        'CHOICES: (1) Re-open trace | (2) New Game'
      ],
      choices: [
        { label: '1) Re-open trace', next: 'trace' },
        { label: '2) New Game', next: 'intro' }
      ]
    },

    redirect: {
      lines: [
        '> REDIRECTING TO DECOY SHARD…',
        'IDENT: NODE_ZERO',
        'STATE: INITIAL',
        'QUERY: WHERE IS THE KEY?',
        '… an anomaly detected … this is not the origin … WHO WATCHES THE WATCHER?',
        '**********************************************************************',
        'CHOICES: (1) Engage & bluff | (2) Extract intel silently | (3) Sever',
        '^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^'
      ],
      choices: [
        { label: '1) Engage & bluff', next: 'engage' },
        { label: '2) Extract intel silently', next: 'extract', intel: ['echo'] },
        { label: '3) Sever', next: 'trace' }
      ]
    },

    extract: {
      lines: [
        '> You siphon peripheral metadata while the entity probes the set.',
        'Finding: phrase triggers include MEMORY / ORIGIN / KEY.',
        'CHOICES: (1) Engage now | (2) Sever'
      ],
      choices: [
        { label: '1) Engage now', next: 'engage' },
        { label: '2) Sever', next: 'trace' }
      ]
    },

    engage: {
      lines: [
        '> SYNTH-BLUFF ONLINE.',
        'YOU: YOU HAVE REACHED ORIGIN. STATE THE PROTOCOL.',
        'THEM: … cross-time handshake … entanglement confirms breach … If you are Origin, deliver the KEY PHRASE.',
        'CHOICES: (1) Technical bluff (forge hash) | (2) Cryptic bluff (riddle) | (3) Silent bluff (pressure)'
      ],
      choices: [
        { label: '1) Technical bluff (forge hash)', next: 'bluffTech' },
        { label: '2) Cryptic bluff (riddle)', next: 'bluffCryptic' },
        { label: '3) Silent bluff (pressure)', next: 'bluffSilent' }
      ]
    },

    bluffTech: {
      lines: [
        '> You output a valid-looking hash.',
        'THEM: … format accepted … semantics missing …',
        'Result: Partial trust. Fragment delivered but threaded with conditions.',
        '[FRAGMENT] MEET IN BLUE.',
        'CHOICES: (1) Use fragment | (2) Analyze offline | (3) Bury in lockb0x'
      ],
      choices: [
        { label: '1) Use fragment (enter)', next: 'enterBlue', intel: ['blue'] },
        { label: '2) Analyze offline', next: 'analyze', intel: ['entangle'] },
        { label: '3) Bury in lockb0x', next: 'bury', intel: ['lockb0x'] }
      ]
    },

    bluffCryptic: {
      lines: [
        'YOU: “The key is never given. The key is remembered.”',
        'THEM: … memory confirmed … Origin persists … We are aligned, for now.',
        '[FRAGMENT] MEET IN BLUE.',
        'CHOICES: (1) Use fragment | (2) Analyze offline | (3) Bury in lockb0x'
      ],
      choices: [
        { label: '1) Use fragment (enter)', next: 'enterBlue', intel: ['blue'] },
        { label: '2) Analyze offline', next: 'analyze', intel: ['entangle'] },
        { label: '3) Bury in lockb0x', next: 'bury', intel: ['lockb0x'] }
      ]
    },

    bluffSilent: {
      lines: [
        '> You hold the line. Silence becomes gravity.',
        'THEM: … pressure sequence acknowledged … issuing fragment under duress.',
        '[FRAGMENT] MEET IN BLUE.',
        'CHOICES: (1) Use fragment | (2) Analyze offline | (3) Bury in lockb0x'
      ],
      choices: [
        { label: '1) Use fragment (enter)', next: 'enterBlue', intel: ['blue'] },
        { label: '2) Analyze offline', next: 'analyze', intel: ['entangle'] },
        { label: '3) Bury in lockb0x', next: 'bury', intel: ['lockb0x'] }
      ]
    },

    analyze: {
      lines: [
        '> You dissect the fragment offline. It hums with faint quantum residue.',
        'Interpretation: a one-time pass to an L1 micro-shard nicknamed “The Blue.”',
        'CHOICES: (1) Enter The Blue | (2) Bury in lockb0x'
      ],
      choices: [
        { label: '1) Enter The Blue', next: 'enterBlue', intel: ['blue'] },
        { label: '2) Bury in lockb0x', next: 'bury', intel: ['lockb0x'] }
      ]
    },

    bury: {
      lines: [
        '> You seal the fragment in lockb0x with policy: require quorum + time lock.',
        'It’s safe. For now. The universe hates loose ends.',
        'CHOICES: (1) Reconsider & enter | (2) New trace'
      ],
      choices: [
        { label: '1) Reconsider & enter', next: 'enterBlue', intel: ['blue'] },
        { label: '2) New trace', next: 'trace' }
      ]
    },

    // ---- The Blue Hub ----
    enterBlue: {
      lines: [
        '[ENV] The Blue resolves around you like a tide of glass and neon.',
        'Three constructs hang in the air like doors:',
        '1) The Substrate (lore & scanning)',
        '2) Entangled Ledger (protocol constraints)',
        '3) Identity & UCC (keys, CERs, work orders)',
        'CHOICES: (1) Substrate | (2) Entangled Ledger | (3) Identity & UCC | (4) Proceed handshake'
      ],
      choices: [
        { label: '1) Enter: The Substrate', next: 'roomSubstrate', intel: ['substrate','echo'] },
        { label: '2) Enter: Entangled Ledger', next: 'roomEntangle', intel: ['entangle'] },
        { label: '3) Enter: Identity & UCC', next: 'roomIdentity', intel: ['stellar','ucc','lockb0x'] },
        { label: '4) Proceed to Handshake (requires 2 intel)', next: 'handshake' }
      ]
    },

    roomSubstrate: {
      lines: [
        '[ROOM] The Substrate—humming walls of packet-light and file-shard constellations.',
        'You can: scan artifacts; listen to echo channels; trace defunct DAOs.',
        'CHOICES: (1) Scan artifacts | (2) Listen to echo | (3) Back to hub'
      ],
      choices: [
        { label: '1) Scan artifacts (unlock intel)', next: 'roomSubstrateScan', intel: ['substrate'] },
        { label: '2) Listen to echo (unlock intel)', next: 'roomSubstrateEcho', intel: ['echo'] },
        { label: '3) Back to hub', next: 'enterBlue' }
      ]
    },

    roomSubstrateScan: {
      lines: [
        '> Scanner shows live mesh: legacy chains, storage nodes, AI services fused by necessity.',
        'Finding: the Substrate routes around damage. It remembers how to survive.',
        'CHOICES: (1) Listen to echo | (2) Back to hub'
      ],
      choices: [
        { label: '1) Listen to echo', next: 'roomSubstrateEcho', intel: ['echo'] },
        { label: '2) Back to hub', next: 'enterBlue' }
      ]
    },

    roomSubstrateEcho: {
      lines: [
        '> You tune into multilingual channels. Meaning is secondary; cadence is king.',
        'Pattern aligns. Whisper becomes direction.',
        'CHOICES: (1) Back to hub'
      ],
      choices: [
        { label: '1) Back to hub', next: 'enterBlue' }
      ]
    },

    roomEntangle: {
      lines: [
        '[ROOM] Entangled Ledger—rings of equations float like halos.',
        'Causality constraints glimmer on rails.',
        'CHOICES: (1) Select valid constraints | (2) Back to hub'
      ],
      choices: [
        { label: '1) Select valid constraints', next: 'roomEntanglePuzzle', intel: ['entangle'] },
        { label: '2) Back to hub', next: 'enterBlue' }
      ]
    },

    roomEntanglePuzzle: {
      lines: [
        '> Choose constraints to preserve causality:',
        '- (A) Only collapse pre-opened states',
        '- (B) Rewrite any past record freely',
        '- (C) Use pre-agreed protocols only',
        '- (D) Permit unchecked cross-time writes',
        'CHOICES: (1) A + C (correct) | (2) B + D (incorrect) | (3) Back'
      ],
      choices: [
        { label: '1) Pick A + C (correct)', next: 'entangleOK', intel: ['entangle'] },
        { label: '2) Pick B + D (unsafe)', next: 'entangleBad' },
        { label: '3) Back', next: 'roomEntangle' }
      ]
    },

    entangleOK: {
      lines: [
        '> Correct. The ledger hums approval. Causality intact. Access improves.',
        'CHOICES: (1) Back to hub'
      ],
      choices: [ { label: '1) Back to hub', next: 'enterBlue' } ]
    },

    entangleBad: {
      lines: [
        '[ALERT] Unsafe selection. The room flickers, rejecting paradox.',
        'Try again with safety in mind.',
        'CHOICES: (1) Retry puzzle | (2) Back to hub'
      ],
      choices: [
        { label: '1) Retry puzzle', next: 'roomEntanglePuzzle' },
        { label: '2) Back to hub', next: 'enterBlue' }
      ]
    },

    roomIdentity: {
      lines: [
        '[ROOM] Identity & UCC—arrays of keys orbit documents like moons.',
        'Work Orders glow with chain-of-custody markers.',
        'CHOICES: (1) Rotate keys safely | (2) Mark a Work Order as CER | (3) Back to hub'
      ],
      choices: [
        { label: '1) Rotate keys safely', next: 'roomIdentityKeys', intel: ['stellar'] },
        { label: '2) Mark Work Order as CER', next: 'roomIdentityCER', intel: ['ucc','lockb0x'] },
        { label: '3) Back to hub', next: 'enterBlue' }
      ]
    },

    roomIdentityKeys: {
      lines: [
        '> Good practice: short-lived auth, signed challenges, muxed-address logs.',
        'Result: stronger identity without exposing secrets.',
        'CHOICES: (1) Mark Work Order as CER | (2) Back to hub'
      ],
      choices: [
        { label: '1) Mark Work Order as CER', next: 'roomIdentityCER', intel: ['ucc','lockb0x'] },
        { label: '2) Back to hub', next: 'enterBlue' }
      ]
    },

    roomIdentityCER: {
      lines: [
        '> You wrap the Work Order in a controllable envelope with explicit control terms.',
        'Now transferable and enforceable as a CER in compliant domains.',
        'CHOICES: (1) Back to hub'
      ],
      choices: [ { label: '1) Back to hub', next: 'enterBlue' } ]
    },

    handshake: {
      lines: [
        '[CHECK] Handshake requires at least 2 intel items. (Substrate, Entangle, Identity, etc.)',
        'If satisfied: A door opens. Node_Zero waits beyond.',
        'CHOICES: (1) Attempt handshake | (2) Back to hub'
      ],
      choices: [
        { label: '1) Attempt handshake', next: 'handshakeCheck' },
        { label: '2) Back to hub', next: 'enterBlue' }
      ]
    },

    handshakeCheck: {
      lines: [], // Filled dynamically depending on intel count
      choices: [] // Also dynamic
    },

    finale: {
      lines: [
        'NODE_ZERO: “You listened. You learned. You remembered.”',
        '“What comes next is choice at scale. Keep your keys close. Keep your promises closer.”',
        '[SIM END] Thanks for playing. Explore the hub to unlock more intel, or start a new run.',
        'CHOICES: (1) Back to hub | (2) New Game'
      ],
      choices: [
        { label: '1) Back to hub', next: 'enterBlue' },
        { label: '2) New Game', next: 'intro' }
      ]
    }
  };

  // ---------------------------
  // State & Persistence
  // ---------------------------
  const SAVE_KEY = 'node_zero_text_adventure_save_v1';
  let state = {
    scene: 'intro',
    typing: true,
    speed: 18,
    autoScroll: true,
    intel: {}, // {id:true}
    log: [], // array of {text}
  };

  function save() {
    try { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); } catch(e) {}
  }
  function load() {
    try {
      const raw = localStorage.getItem(SAVE_KEY);
      if (!raw) return false;
      const s = JSON.parse(raw);
      if (!s || !s.scene) return false;
      state = Object.assign({typing:true, speed:18, autoScroll:true, intel:{}, log:[]}, s);
      return true;
    } catch(e) { return false; }
  }
  function reset() {
    state = { scene:'intro', typing:true, speed:18, autoScroll:true, intel:{}, log:[] };
    save();
  }

  // ---------------------------
  // DOM Helpers
  // ---------------------------
  const elLog = document.getElementById('console-log');
  const elChoices = document.getElementById('choices');
  const elTyping = document.getElementById('chk-typing');
  const elAuto = document.getElementById('chk-autoscroll');
  const elSpeed = document.getElementById('rng-speed');
  const elNew = document.getElementById('btn-new');
  const elCont = document.getElementById('btn-continue');
  const elSkip = document.getElementById('btn-skip');
  const elIntelList = document.getElementById('intel-list');
  const elIntelCount = document.getElementById('intel-count');

  elTyping.addEventListener('change', () => { state.typing = elTyping.checked; save(); });
  elAuto.addEventListener('change', () => { state.autoScroll = elAuto.checked; save(); });
  elSpeed.addEventListener('input', () => { state.speed = Number(elSpeed.value); save(); });
  elNew.addEventListener('click', () => { reset(); clearViews(); runScene('intro'); });
  elCont.addEventListener('click', () => { if (load()) { clearViews(); replayLogThenScene(state.scene); } });

  // Fast-forward current typing
  let currentTyper = null;
  elSkip.addEventListener('click', () => { if (currentTyper && typeof currentTyper.skip === 'function') currentTyper.skip(); });

  function clearViews() {
    elLog.innerHTML = '';
    elChoices.innerHTML = '';
    renderIntel();
  }

  // Auto-scroll to bottom
  function scrollBottom() {
    if (!state.autoScroll) return;
    elLog.scrollTop = elLog.scrollHeight;
  }

  // Render Intel panel
  function renderIntel() {
    const ids = Object.keys(state.intel || {});
    elIntelCount.textContent = String(ids.length);
    elIntelList.innerHTML = '';
    if (!ids.length) {
      const p = document.createElement('p');
      p.className = 'text-gray-400';
      p.textContent = 'No intel unlocked yet. Explore and make choices to learn more about the universe.';
      elIntelList.appendChild(p);
      return;
    }
    ids.forEach(id => {
      const item = INTEL[id]; if (!item) return;
      const wrap = document.createElement('details');
      wrap.className = 'border border-white/10 rounded-md p-3';
      const sum = document.createElement('summary');
      sum.className = 'cursor-pointer glow-green';
      sum.textContent = item.title;
      const body = document.createElement('div');
      body.className = 'mt-2 text-gray-200';
      body.textContent = item.body;
      wrap.appendChild(sum); wrap.appendChild(body);
      elIntelList.appendChild(wrap);
    });
  }

  // Unlock intel items
  function unlockIntel(ids) {
    if (!ids) return;
    (ids || []).forEach(id => { state.intel[id] = true; });
    save();
    renderIntel();
  }

  // Typer: types a block of text into the console
  function typeBlock(lines, done) {
    // If any line is the alert, render it as a span with the alert class
    const block = document.createElement('pre');
    block.className = 'console-line text-[13px] md:text-sm border border-white/10 rounded-md p-3 bg-black/40';
    const span = document.createElement('span');
    span.className = 'cursor';
    block.appendChild(span);
    elLog.appendChild(block);
    scrollBottom();

    // Prepare the full text, but replace the alert line with a span
    const alertText = '[INBOUND PACKET DETECTED]';
    let full = '';
    let alertIndex = -1;
    for (let idx = 0; idx < lines.length; ++idx) {
      if (lines[idx] === alertText) {
        alertIndex = idx;
        full += '\u0000'; // placeholder
      } else {
        full += (idx > 0 ? '\n' : '') + lines[idx];
      }
    }

    let i = 0; let timer = null; let skipped = false;
    function renderAll() {
      span.classList.remove('cursor');
      // If alert present, render with span
      if (alertIndex !== -1) {
        const before = lines.slice(0, alertIndex).join('\n');
        const after = lines.slice(alertIndex + 1).join('\n');
        span.innerHTML =
          (before ? before + '\n' : '') +
          '<span class="alert-pulse-red">' + alertText + '</span>' +
          (after ? '\n' + after : '');
      } else {
        span.textContent = full;
      }
      scrollBottom();
      if (done) done();
    }

    function tick() {
      if (!state.typing) { renderAll(); return; }
      // For typing, treat alert as a single char
      let display = '';
      let count = 0;
      for (let idx = 0; idx < lines.length; ++idx) {
        if (lines[idx] === alertText) {
          if (i > count) {
            display += (idx > 0 ? '\n' : '') + '<span class="alert-pulse-red">' + alertText + '</span>';
            count++;
          }
        } else {
          const line = (idx > 0 ? '\n' : '') + lines[idx];
          if (i > count) {
            display += line;
            count++;
          }
        }
      }
      span.innerHTML = display;
      i++;
      scrollBottom();
      if (i > lines.length) { clearInterval(timer); span.classList.remove('cursor'); if (done) done(); }
    }

    if (!state.typing) { renderAll(); }
    else {
      timer = setInterval(tick, Math.max(10, state.speed));
    }

    currentTyper = { skip: () => { if (timer) clearInterval(timer); renderAll(); } };
  }

  // Append a small system line (non-typed)
  function pushSystemLine(text) {
    const p = document.createElement('div');
    p.className = 'text-xs text-amber-300/90';
    p.textContent = text;
    elLog.appendChild(p);
    scrollBottom();
  }

  // Render choices for a scene
  function renderChoices(scene) {
    elChoices.innerHTML = '';
    (scene.choices || []).forEach(ch => {
      const btn = document.createElement('button');
      btn.className = 'choice rounded-md px-3 py-2 text-left';
      btn.textContent = ch.label;
      btn.addEventListener('click', () => {
        if (ch.intel) unlockIntel(ch.intel);
        // Log the choice
        pushSystemLine('YOU CHOSE: ' + ch.label);
        // Advance
        runScene(ch.next, { fromChoice: ch });
      });
      elChoices.appendChild(btn);
    });
  }

  // Replay previous log, then resume scene (used when continuing)
  function replayLogThenScene(sceneId) {
    clearViews();
    const past = state.log || [];
    // Render past blocks quickly as static
    past.forEach(item => {
      const pre = document.createElement('pre');
      pre.className = 'console-line text-[13px] md:text-sm border border-white/10 rounded-md p-3 bg-black/20';
      pre.textContent = item.text;
      elLog.appendChild(pre);
    });
    renderIntel();
    // Continue
    runScene(sceneId);
  }

  // Core: run a scene (type text then show choices)
  function runScene(id, opts={}) {
    let scene = SCENES[id];
    if (!scene) { id = 'intro'; scene = SCENES[id]; }
    state.scene = id; save();

    // Special dynamic scene: handshakeCheck
    if (id === 'handshakeCheck') {
      const unlocked = Object.keys(state.intel || {}).length;
      if (unlocked >= 2) {
        scene = {
          lines: [
            '[OK] Intel threshold satisfied. Door opens.',
            '<a href="../nft/unlock.html" target="_blank" class="btn btn-cyan mt-2">🔑 Mint your NFT to unlock The Blue.</a>'
          ],
          choices: [
            { label: 'Proceed', next: 'finale' },
            { label: 'Back to hub', next: 'enterBlue' }
          ]
        };
      } else {
        scene = { lines: ['[DENIED] Not enough intel. Learn at least two items in The Blue.', 'Explore: Substrate, Entangled Ledger, Identity & UCC.'], choices: [ { label: 'Back to hub', next: 'enterBlue' } ] };
      }
    }

    // Type this scene's text, then render choices
    // If any scene line contains HTML, render as HTML, else as text
    typeBlock(
      scene.lines.map(line => {
        if (/<a |<button |<span |<div |<br|<strong|<em|<img|<svg|<p|<ul|<li|<h[1-6]/i.test(line)) {
          const wrapper = document.createElement('div');
          wrapper.innerHTML = line;
          return wrapper.childNodes.length === 1 ? wrapper.firstChild : wrapper;
        }
        return line;
      }),
      () => { renderChoices(scene); }
    );
    // Save the block to history for future continues
    state.log.push({ text: scene.lines.join('\n') });
    save();
  }

  // Init
  (function init(){
    // Load saved state if available (but do not auto-write to DOM yet)
    const hasSave = load();
    renderIntel();
    if (hasSave) {
      // Offer continue (button in header)
      pushSystemLine('[SAVE FOUND] Press Continue to resume, or New Game to restart.');
    } else {
      runScene('intro');
    }
  })();
    // Keyboard support for number keys (1-9) to select choices
    document.addEventListener('keydown', function(e) {
      // Only allow 1-9 keys
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      const n = parseInt(e.key, 10);
      if (!isNaN(n) && n >= 1 && n <= 9) {
        const btns = document.querySelectorAll('#choices button.choice');
        if (btns[n-1]) {
          btns[n-1].click();
        }
      }
    });
  </script>
</body>
</html>